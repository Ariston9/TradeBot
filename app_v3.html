<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Trade Assistant WebApp v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="style_v3.css" />
</head>

<body>
<div class="app-root">

  <!-- ======= ХЕДЕР ======= -->
  <header class="app-header">
    <div class="header-left">
      <div class="header-logo"></div>
      <div class="header-text">
        <div class="header-title">Trade Assistant</div>
        <div class="header-subtitle">Надёжный помощник в трейдинге</div>
      </div>
    </div>

    <div class="header-right">
      <div class="api-pill" id="statusPill">API: неизвестно</div>

      <label class="pair-label" for="pair">Валютная пара</label>
      <select id="pair" class="pair-select">
        <!-- EUR pairs -->
        <option value="EURUSD" data-api="EUR/USD">🇪🇺 EUR/USD 🇺🇸</option>
        <option value="EURGBP" data-api="EUR/GBP">🇪🇺 EUR/GBP 🇬🇧</option>
        <option value="EURAUD" data-api="EUR/AUD">🇪🇺 EUR/AUD 🇦🇺</option>
        <option value="EURJPY" data-api="EUR/JPY">🇪🇺 EUR/JPY 🇯🇵</option>
        <option value="EURCHF" data-api="EUR/CHF">🇪🇺 EUR/CHF 🇨🇭</option>
        <option value="EURCAD" data-api="EUR/CAD">🇪🇺 EUR/CAD 🇨🇦</option>

        <!-- GBP pairs -->
        <option value="GBPUSD" data-api="GBP/USD">🇬🇧 GBP/USD 🇺🇸</option>
        <option value="GBPJPY" data-api="GBP/JPY">🇬🇧 GBP/JPY 🇯🇵</option>
        <option value="GBPCHF" data-api="GBP/CHF">🇬🇧 GBP/CHF 🇨🇭</option>
        <option value="GBPAUD" data-api="GBP/AUD">🇬🇧 GBP/AUD 🇦🇺</option>
        <option value="GBPCAD" data-api="GBP/CAD">🇬🇧 GBP/CAD 🇨🇦</option>

        <!-- USD pairs -->
        <option value="USDJPY" data-api="USD/JPY">🇺🇸 USD/JPY 🇯🇵</option>
        <option value="USDCAD" data-api="USD/CAD">🇺🇸 USDCAD 🇨🇦</option>
        <option value="USDCHF" data-api="USD/CHF">🇺🇸 USD/CHF 🇨🇭</option>

        <!-- AUD pairs -->
        <option value="AUDUSD" data-api="AUD/USD">🇦🇺 AUD/USD 🇺🇸</option>
        <option value="AUDJPY" data-api="AUD/JPY">🇦🇺 AUD/JPY 🇯🇵</option>
        <option value="AUDCHF" data-api="AUD/CHF">🇦🇺 AUD/CHF 🇨🇭</option>
        <option value="AUDCAD" data-api="AUD/CAD">🇦🇺 AUD/CAD 🇨🇦</option>

        <!-- CAD pairs -->
        <option value="CADJPY" data-api="CAD/JPY">🇨🇦 CAD/JPY 🇯🇵</option>
        <option value="CADCHF" data-api="CAD/CHF">🇨🇦 CAD/CHF 🇨🇭</option>
      </select>
    </div>
  </header>

  <!-- ======= ГЛАВНАЯ ПРОКРУЧИВАЕМАЯ ЗОНА ======= -->
  <main class="app-main">

    <!-- --- Вкладка Сигнал --- -->
    <section id="tab-signal" class="tab-content active">
      <div class="card">
        <div class="signal-header-row">
          <div>
            <div id="signal-title" class="signal-direction">
              ⏳ Ожидание сигнала...
            </div>
            <div id="prob" class="signal-prob muted">
              Нажми «Получить сигнал»
            </div>
          </div>
        </div>

        <div class="signal-extra-row">
          <div id="expiry" class="signal-extra">Экспирация: –</div>
          <div id="price" class="signal-extra">Цена входа: –</div>
          <div id="direction" class="signal-extra">Направление: –</div>
        </div>

        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <span id="chartTitle">График: EUR/USD</span>
        </div>
        <div id="chart-container" class="chart-container"></div>
      </div>
    </section>

    <!-- --- Вкладка История --- -->
    <section id="tab-history" class="tab-content">
      <div class="card">
        <h3>📜 История сигналов</h3>
        <p class="muted small">Показываются последние сигналы по выбранной паре.</p>
        <div id="signals" class="signals-list">
          <p class="muted">
            Пока нет данных. Нажми «Получить сигнал», чтобы начать.
          </p>
        </div>
      </div>
    </section>

    <!-- --- Вкладка Статистика --- -->
    <section id="tab-stats" class="tab-content">
      <div class="card">
        <h3>📊 Статистика по паре</h3>
        <p class="muted small">Краткая статистика по последним сигналам бота.</p>

        <div class="stats-grid">
          <div class="stats-item">
            <div class="stats-label">Всего сигналов:</div>
            <div id="stat-total" class="stats-value">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Плюсовых (WIN):</div>
            <div id="stat-wins" class="stats-value win">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Минусовых (LOSS):</div>
            <div id="stat-losses" class="stats-value loss">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">WinRate:</div>
            <div id="stat-winrate" class="stats-value">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">BUY:</div>
            <div id="stat-buy" class="stats-value">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">SELL:</div>
            <div id="stat-sell" class="stats-value">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Средняя вероятность:</div>
            <div id="stat-avg-prob" class="stats-value">–</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Последняя активность:</div>
            <div id="stat-last" class="stats-value small">–</div>
          </div>
        </div>

        <div class="card-mini">
          <h4>📈 Диаграмма Win / Loss</h4>
          <div class="stat-chart-bar">
            <div id="stat-win-bar" class="stat-win-bar"></div>
            <div id="stat-loss-bar" class="stat-loss-bar"></div>
          </div>
          <div class="stat-chart-legend">
            <span class="legend-item">
              <span class="legend-box win"></span> WIN
            </span>
            <span class="legend-item">
              <span class="legend-box loss"></span> LOSS
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- --- Вкладка Автоскан --- -->
    <section id="tab-autoscan" class="tab-content">
      <div class="card">
        <h3>🔄 Сигналы автосканера</h3>
        <p class="muted small">
          Здесь можно отображать последние сигналы, которые бот отправляет в режиме автосканера.
        </p>
        <div id="autoscan-info" class="autoscan-box">
          <p class="muted">
            Пока тут просто заглушка. Позже можно вывести сюда список активных пар и последние автосигналы.
          </p>
        </div>
      </div>
    </section>

  </main>

  <!-- ======= НИЖНЯЯ НАВИГАЦИЯ (Таббар) ======= -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="signal" onclick="switchTab('signal')">
      <img class="nav-icon" src="icons/Signal.svg" alt="" />
      <span class="nav-label">Сигнал</span>
    </button>
    <button class="nav-item" data-tab="history" onclick="switchTab('history')">
      <img class="nav-icon" src="icons/History.svg" alt="" />
      <span class="nav-label">История</span>
    </button>
    <button class="nav-item" data-tab="stats" onclick="switchTab('stats')">
      <img class="nav-icon" src="icons/Statistics.svg" alt="" />
      <span class="nav-label">Статистика</span>
    </button>
    <button class="nav-item" data-tab="autoscan" onclick="switchTab('autoscan')">
      <img class="nav-icon" src="icons/Autoscan.svg" alt="" />
      <span class="nav-label">Автоскан</span>
    </button>
  </nav>

</div>

<!-- Telegram & TradingView -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.expand) tg.expand();

  // ====== БАЗОВЫЙ URL API: всегда из ?api=... ======
  function getApiBase() {
    const pill = document.getElementById("statusPill");
    const params = new URLSearchParams(window.location.search);
    const apiFromParam = params.get("api");

    if (apiFromParam) {
      const clean = apiFromParam.replace(/\/+$/, "");
      pill.textContent = "API: Colab/ngrok";
      pill.classList.add("status-ok");
      return clean;
    }

    pill.textContent = "API: не задан (?api=...)";
    pill.classList.add("status-warn");
    return "";
  }

  let API_BASE = getApiBase();
  let tvWidget = null;

  function getCurrentPair() {
    const select = document.getElementById("pair");
    const opt = select.options[select.selectedIndex];
    return {
      tvSymbol: opt.value,     // EURUSD
      apiPair: opt.dataset.api // EUR/USD
    };
  }

  function switchTab(tab) {
    document.querySelectorAll(".tab-content").forEach(sec => {
      sec.classList.toggle("active", sec.id === "tab-" + tab);
    });
    document.querySelectorAll(".nav-item").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });

    if (tab === "stats") {
      const p = getCurrentPair();
      loadStats(p.tvSymbol);
    }
    if (tab === "history") {
      const p = getCurrentPair();
      loadSignals(p.tvSymbol);
    }
  }

  function setLoading(isLoading) {
    const btn = document.getElementById("signalButton");
    if (!btn) return;
    if (isLoading) {
      btn.classList.add("btn-loading");
      btn.textContent = "⏳ Анализ...";
    } else {
      btn.classList.remove("btn-loading");
      btn.textContent = "Получить сигнал";
    }
  }

  // ====== Получение сигнала ======
  async function updateSignal() {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "График: " + apiPair;
    document.getElementById("signal-title").textContent = "⏳ Анализ " + apiPair + "...";
    document.getElementById("prob").textContent = "";
    document.getElementById("expiry").textContent = "Экспирация: –";
    document.getElementById("price").textContent = "Цена входа: –";
    document.getElementById("direction").textContent = "Направление: –";
    document.getElementById("progressBar").style.width = "0%";

    if (!API_BASE) {
      document.getElementById("signal-title").textContent = "❌ Не задан API";
      document.getElementById("prob").textContent = "Добавь ?api=URL_ТВОЕГО_COLAB";
      return;
    }

    setLoading(true);
    switchTab("signal");

    let data;
    try {
      const url = `${API_BASE}/get_signal?pair=${encodeURIComponent(apiPair)}`;
      const res = await fetch(url, {
        headers: { "ngrok-skip-browser-warning": "true" }
      });

      const raw = await res.text();
      console.log("RAW SIGNAL RESPONSE:", raw);

      try {
        data = JSON.parse(raw);
      } catch (err) {
        // разовый повтор, если Colab/NGROK отдал HTML/текст
        console.warn("❗ Не-JSON ответ, повтор через 300 мс");
        await new Promise(r => setTimeout(r, 300));
        const res2 = await fetch(url, {
          headers: { "ngrok-skip-browser-warning": "true" }
        });
        const raw2 = await res2.text();
        console.log("Retry RAW:", raw2);
        data = JSON.parse(raw2);
      }
    } catch (e) {
      console.error("Signal fetch error:", e);
      setLoading(false);
      document.getElementById("signal-title").textContent = "❌ Ошибка загрузки сигнала";
      document.getElementById("prob").textContent = "Проверь интернет или API Colab/ngrok.";
      return;
    }

    setLoading(false);

    if (!data || typeof data !== "object") {
      document.getElementById("signal-title").textContent = "❌ Ошибка сигнала";
      document.getElementById("prob").textContent = "Неверный формат ответа API.";
      return;
    }

    if (data.error) {
      document.getElementById("signal-title").textContent = "⚠️ " + data.error;
      document.getElementById("prob").textContent = "";
      showChart(tvSymbol);
      return;
    }

    // ====== Нормальный сигнал ======
    const dir = (data.direction || data.dir || "NONE").toUpperCase();
    const prob = Number(data.probability ?? data.prob ?? 0);
    const expiryMin = data.expiry;
    const entryPrice = data.entry_price ?? data.entry ?? null;

    const dirEl = document.getElementById("signal-title");
    dirEl.classList.remove("buy", "sell");

    if (dir === "BUY") {
      dirEl.textContent = "Покупать 🟢";
      dirEl.classList.add("buy");
    } else if (dir === "SELL") {
      dirEl.textContent = "Продавать 🔴";
      dirEl.classList.add("sell");
    } else {
      dirEl.textContent = "⚪ Сигнал слабый";
    }

    document.getElementById("prob").textContent =
      "Вероятность: " + prob.toFixed(0) + "%";

    if (expiryMin == null || expiryMin === 0) {
      document.getElementById("expiry").textContent = "Экспирация: –";
      document.getElementById("progressBar").style.width = "0%";
    } else {
      document.getElementById("expiry").textContent =
        "Экспирация: " + expiryMin + " мин";
      const width = Math.max(5, Math.min(100, (expiryMin / 30) * 100));
      document.getElementById("progressBar").style.width = width + "%";
    }

    if (entryPrice != null) {
      document.getElementById("price").textContent =
        "Цена входа: " + Number(entryPrice).toFixed(5);
    }
    document.getElementById("direction").textContent =
      "Направление: " + dir;

    showChart(tvSymbol);
    loadSignals(tvSymbol);
    loadStats(tvSymbol);
  }

  // ====== TradingView ======
  function showChart(symbol) {
    const container = document.getElementById("chart-container");
    if (!container) return;

    if (tvWidget) {
      tvWidget.setSymbol(symbol);
      return;
    }

    tvWidget = new TradingView.widget({
      autosize: true,
      symbol: symbol,
      interval: "1",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      hide_top_toolbar: false,
      hide_legend: false,
      container_id: "chart-container",
    });
  }
  // let tvWidget = null;

  // function safeChartInit(tvSymbol, entryPrice = null, dir = null) {
  //   // === 1. Если виджет уже создан → просто меняем символ ===
  //   if (tvWidget) {
  //     try {
  //       tvWidget.chart().setSymbol("FX:" + tvSymbol);
  
  //       // И если нужно — перерисовываем стрелку
  //       if (entryPrice) {
  //         tvWidget.onChartReady(() => {
  //           try {
  //             tvWidget.chart().createMultipointShape(
  //               [{ price: parseFloat(entryPrice) }],
  //               {
  //                 shape: dir === "SELL" ? "arrow_down" : "arrow_up",
  //                 text: dir || "",
  //                 lock: true,
  //                 disableSelection: true
  //               }
  //             );
  //           } catch (e) {
  //             console.warn("Arrow place error:", e);
  //           }
  //         });
  //       }
  
  //       return; // важное — НЕ создаём новый widget
  //     } catch (e) {
  //       console.warn("setSymbol error:", e);
  //     }
  //   }
  
    // === 2. Виджет создаём только один раз ===
    const container = document.getElementById("chart-container");
    container.innerHTML = "";
  
    try {
      tvWidget = new TradingView.widget({
        autosize: true,
        symbol: "FX:" + tvSymbol,
        interval: "1",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "ru",
        container_id: "chart-container",
      });
    } catch (e) {
      console.warn("TradingView init error:", e);
      return;
    }
  
    // === 3. Когда график готов → добавляем стрелку, если есть ===
    if (entryPrice && !isNaN(parseFloat(entryPrice))) {
      tvWidget.onChartReady(() => {
        try {
          tvWidget.chart().createMultipointShape(
            [{ price: parseFloat(entryPrice) }],
            {
              shape: dir === "SELL" ? "arrow_down" : "arrow_up",
              text: dir || "",
              lock: true,
              disableSelection: true
            }
          );
        } catch (e) {
          console.warn("Arrow place error:", e);
        }
      });
    }
  }

  // ====== История сигналов ======
  async function loadSignals(tvSymbol) {
  if (!API_BASE) return;
  try {
    const res = await fetch(`${API_BASE}/signals?symbol=${tvSymbol}`, {
      headers: { "ngrok-skip-browser-warning": "true" }
    });

    let data;
    try { data = await res.json(); }
    catch { console.warn("History JSON error"); return; }

    const div = document.getElementById("signals");
    div.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      div.innerHTML = "<p class='muted'>Пока нет сигналов</p>";
      return;
    }

    data.slice(-30).reverse().forEach(s => {
      const el = document.createElement("div");
      el.className = "signal-row " + (s.direction === "BUY" ? "buy" : "sell");
      el.innerHTML = `
        <div class="signal-main">
          <span class="signal-time">${s.time || ""}</span>
          <span class="signal-dir">${s.direction || ""}</span>
        </div>
        <div class="signal-reason">${s.reason || ""}</div>
      `;
      div.appendChild(el);
    });

  } catch (e) {
    console.warn("History error:", e);
  }
}

  // ====== Статистика ======
  async function loadStats(tvSymbol) {
    if (!API_BASE) return;
    try {
      const res = await fetch(
        `${API_BASE}/stats?symbol=${encodeURIComponent(tvSymbol)}`,
        { headers: { "ngrok-skip-browser-warning": "true" } }
      );
      const data = await res.json();

      if (!data || typeof data !== "object") {
        console.warn("Bad stats payload", data);
        return;
      }

      const total   = data.total   ?? 0;
      const wins    = data.wins    ?? 0;
      const losses  = data.losses  ?? 0;
      const buy     = data.buy     ?? 0;
      const sell    = data.sell    ?? 0;
      const winrate = data.winrate ?? 0;
      const avgProb = data.avg_prob ?? 0;
      const last    = data.last_active || "–";

      document.getElementById("stat-total").textContent    = total;
      document.getElementById("stat-wins").textContent     = wins;
      document.getElementById("stat-losses").textContent   = losses;
      document.getElementById("stat-buy").textContent      = buy;
      document.getElementById("stat-sell").textContent     = sell;
      document.getElementById("stat-winrate").textContent  = winrate + "%";
      document.getElementById("stat-avg-prob").textContent = avgProb + "%";
      document.getElementById("stat-last").textContent     = last;

      const winBar  = document.getElementById("stat-win-bar");
      const lossBar = document.getElementById("stat-loss-bar");
      let winPerc = 0, lossPerc = 0;
      if (wins + losses > 0) {
        winPerc  = (wins  / (wins + losses)) * 100;
        lossPerc = (losses / (wins + losses)) * 100;
      }
      winBar.style.width  = winPerc  + "%";
      lossBar.style.width = lossPerc + "%";
    } catch (e) {
      console.error("Stats error:", e);
    }
  }

  // ====== Инициализация ======
  window.addEventListener("load", () => {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "График: " + apiPair;
    showChart(tvSymbol);
    loadStats(tvSymbol);
  });

  document.getElementById("pair").addEventListener("change", () => {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "График: " + apiPair;
    showChart(tvSymbol);
    loadStats(tvSymbol);
    loadSignals(tvSymbol);
  });
</script>

<!-- Плавающая кнопка -->
<button id="signalButton" class="floating-signal-btn" onclick="updateSignal()">
  Получить сигнал
</button>

</body>
</html>
