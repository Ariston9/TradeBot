<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Trade Assistant WebApp v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="style_v3.css" />
</head>

<body>
<div class="app-root">

  <!-- ======= Ğ¥Ğ•Ğ”Ğ•Ğ  ======= -->
  <header class="app-header">
    <div class="header-left">
      <div class="header-logo"></div>
      <div class="header-text">
        <div class="header-title">Trade Assistant</div>
        <div class="header-subtitle">ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ² Ñ‚Ñ€ĞµĞ¹Ğ´Ğ¸Ğ½Ğ³Ğµ</div>
      </div>
    </div>

    <div class="header-right">
      <div class="api-pill" id="statusPill">API: Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾</div>

      <label class="pair-label" for="pair">Ğ’Ğ°Ğ»ÑÑ‚Ğ½Ğ°Ñ Ğ¿Ğ°Ñ€Ğ°</label>
      <select id="pair" class="pair-select">
        <!-- EUR pairs -->
        <option value="EURUSD" data-api="EUR/USD">ğŸ‡ªğŸ‡º EUR/USD ğŸ‡ºğŸ‡¸</option>
        <option value="EURGBP" data-api="EUR/GBP">ğŸ‡ªğŸ‡º EUR/GBP ğŸ‡¬ğŸ‡§</option>
        <option value="EURAUD" data-api="EUR/AUD">ğŸ‡ªğŸ‡º EUR/AUD ğŸ‡¦ğŸ‡º</option>
        <option value="EURJPY" data-api="EUR/JPY">ğŸ‡ªğŸ‡º EUR/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="EURCHF" data-api="EUR/CHF">ğŸ‡ªğŸ‡º EUR/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="EURCAD" data-api="EUR/CAD">ğŸ‡ªğŸ‡º EUR/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- GBP pairs -->
        <option value="GBPUSD" data-api="GBP/USD">ğŸ‡¬ğŸ‡§ GBP/USD ğŸ‡ºğŸ‡¸</option>
        <option value="GBPJPY" data-api="GBP/JPY">ğŸ‡¬ğŸ‡§ GBP/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="GBPCHF" data-api="GBP/CHF">ğŸ‡¬ğŸ‡§ GBP/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="GBPAUD" data-api="GBP/AUD">ğŸ‡¬ğŸ‡§ GBP/AUD ğŸ‡¦ğŸ‡º</option>
        <option value="GBPCAD" data-api="GBP/CAD">ğŸ‡¬ğŸ‡§ GBP/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- USD pairs -->
        <option value="USDJPY" data-api="USD/JPY">ğŸ‡ºğŸ‡¸ USD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="USDCAD" data-api="USD/CAD">ğŸ‡ºğŸ‡¸ USDCAD ğŸ‡¨ğŸ‡¦</option>
        <option value="USDCHF" data-api="USD/CHF">ğŸ‡ºğŸ‡¸ USD/CHF ğŸ‡¨ğŸ‡­</option>

        <!-- AUD pairs -->
        <option value="AUDUSD" data-api="AUD/USD">ğŸ‡¦ğŸ‡º AUD/USD ğŸ‡ºğŸ‡¸</option>
        <option value="AUDJPY" data-api="AUD/JPY">ğŸ‡¦ğŸ‡º AUD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="AUDCHF" data-api="AUD/CHF">ğŸ‡¦ğŸ‡º AUD/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="AUDCAD" data-api="AUD/CAD">ğŸ‡¦ğŸ‡º AUD/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- CAD pairs -->
        <option value="CADJPY" data-api="CAD/JPY">ğŸ‡¨ğŸ‡¦ CAD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="CADCHF" data-api="CAD/CHF">ğŸ‡¨ğŸ‡¦ CAD/CHF ğŸ‡¨ğŸ‡­</option>
      </select>
    </div>
  </header>

  <!-- ======= Ğ“Ğ›ĞĞ’ĞĞĞ¯ ĞŸĞ ĞĞšĞ Ğ£Ğ§Ğ˜Ğ’ĞĞ•ĞœĞĞ¯ Ğ—ĞĞĞ ======= -->
  <main class="app-main">

    <!-- --- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» --- -->
    <section id="tab-signal" class="tab-content active">
      <div class="card">
        <div class="signal-header-row">
          <div>
            <div id="signal-title" class="signal-direction">
              â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°...
            </div>
            <div id="prob" class="signal-prob muted">
              ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Â»
            </div>
          </div>
        </div>

        <div class="signal-extra-row">
          <div id="expiry" class="signal-extra">Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: â€“</div>
          <div id="price" class="signal-extra">Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: â€“</div>
          <div id="direction" class="signal-extra">ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: â€“</div>
        </div>

        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <span id="chartTitle">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: EUR/USD</span>
        </div>
        <div id="chart-container" class="chart-container"></div>
      </div>
    </section>

    <!-- --- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ --- -->
    <section id="tab-history" class="tab-content">
      <div class="card">
        <h3>ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²</h3>
        <p class="muted small">ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ¿Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğµ.</p>
        <div id="signals" class="signals-list">
          <p class="muted">
            ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Â», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ.
          </p>
        </div>
      </div>
    </section>

    <!-- --- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° --- -->
    <section id="tab-stats" class="tab-content">
      <div class="card">
        <h3>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğµ</h3>
        <p class="muted small">ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°Ğ¼ Ğ±Ğ¾Ñ‚Ğ°.</p>

        <div class="stats-grid">
          <div class="stats-item">
            <div class="stats-label">Ğ’ÑĞµĞ³Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²:</div>
            <div id="stat-total" class="stats-value">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">ĞŸĞ»ÑÑĞ¾Ğ²Ñ‹Ñ… (WIN):</div>
            <div id="stat-wins" class="stats-value win">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">ĞœĞ¸Ğ½ÑƒÑĞ¾Ğ²Ñ‹Ñ… (LOSS):</div>
            <div id="stat-losses" class="stats-value loss">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">WinRate:</div>
            <div id="stat-winrate" class="stats-value">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">BUY:</div>
            <div id="stat-buy" class="stats-value">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">SELL:</div>
            <div id="stat-sell" class="stats-value">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ:</div>
            <div id="stat-avg-prob" class="stats-value">â€“</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ:</div>
            <div id="stat-last" class="stats-value small">â€“</div>
          </div>
        </div>

        <div class="card-mini">
          <h4>ğŸ“ˆ Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Win / Loss</h4>
          <div class="stat-chart-bar">
            <div id="stat-win-bar" class="stat-win-bar"></div>
            <div id="stat-loss-bar" class="stat-loss-bar"></div>
          </div>
          <div class="stat-chart-legend">
            <span class="legend-item">
              <span class="legend-box win"></span> WIN
            </span>
            <span class="legend-item">
              <span class="legend-box loss"></span> LOSS
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- --- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° ĞĞ²Ñ‚Ğ¾ÑĞºĞ°Ğ½ --- -->
    <section id="tab-autoscan" class="tab-content">
      <div class="card">
        <h3>ğŸ”„ Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ°Ğ²Ñ‚Ğ¾ÑĞºĞ°Ğ½ĞµÑ€Ğ°</h3>
        <p class="muted small">
          Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±Ğ¾Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ°Ğ²Ñ‚Ğ¾ÑĞºĞ°Ğ½ĞµÑ€Ğ°.
        </p>
        <div id="autoscan-info" class="autoscan-box">
          <p class="muted">
            ĞŸĞ¾ĞºĞ° Ñ‚ÑƒÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°. ĞŸĞ¾Ğ·Ğ¶Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ²ĞµÑÑ‚Ğ¸ ÑÑĞ´Ğ° ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€ Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹.
          </p>
        </div>
      </div>
    </section>

  </main>

  <!-- ======= ĞĞ˜Ğ–ĞĞ¯Ğ¯ ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜Ğ¯ (Ğ¢Ğ°Ğ±Ğ±Ğ°Ñ€) ======= -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="signal" onclick="switchTab('signal')">
      <img class="nav-icon" src="icons/Signal.svg" alt="" />
      <span class="nav-label">Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»</span>
    </button>
    <button class="nav-item" data-tab="history" onclick="switchTab('history')">
      <img class="nav-icon" src="icons/History.svg" alt="" />
      <span class="nav-label">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</span>
    </button>
    <button class="nav-item" data-tab="stats" onclick="switchTab('stats')">
      <img class="nav-icon" src="icons/Statistics.svg" alt="" />
      <span class="nav-label">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</span>
    </button>
    <button class="nav-item" data-tab="autoscan" onclick="switchTab('autoscan')">
      <img class="nav-icon" src="icons/Autoscan.svg" alt="" />
      <span class="nav-label">ĞĞ²Ñ‚Ğ¾ÑĞºĞ°Ğ½</span>
    </button>
  </nav>

</div>

<!-- Telegram & TradingView -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.expand) tg.expand();

  // ====== Ğ‘ĞĞ—ĞĞ’Ğ«Ğ™ URL API: Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ· ?api=... ======
  function getApiBase() {
    const pill = document.getElementById("statusPill");
    const params = new URLSearchParams(window.location.search);
    const apiFromParam = params.get("api");

    if (apiFromParam) {
      const clean = apiFromParam.replace(/\/+$/, "");
      pill.textContent = "API: Colab/ngrok";
      pill.classList.add("status-ok");
      return clean;
    }

    pill.textContent = "API: Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ (?api=...)";
    pill.classList.add("status-warn");
    return "";
  }

  let API_BASE = getApiBase();
  let tvWidget = null;

  function getCurrentPair() {
    const select = document.getElementById("pair");
    const opt = select.options[select.selectedIndex];
    return {
      tvSymbol: opt.value,     // EURUSD
      apiPair: opt.dataset.api // EUR/USD
    };
  }

  function switchTab(tab) {
    document.querySelectorAll(".tab-content").forEach(sec => {
      sec.classList.toggle("active", sec.id === "tab-" + tab);
    });
    document.querySelectorAll(".nav-item").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });

    if (tab === "stats") {
      const p = getCurrentPair();
      loadStats(p.tvSymbol);
    }
    if (tab === "history") {
      const p = getCurrentPair();
      loadSignals(p.tvSymbol);
    }
  }

  function setLoading(isLoading) {
    const btn = document.getElementById("signalButton");
    if (!btn) return;
    if (isLoading) {
      btn.classList.add("btn-loading");
      btn.textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ·...";
    } else {
      btn.classList.remove("btn-loading");
      btn.textContent = "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»";
    }
  }

  // ====== ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ° ======
  async function updateSignal() {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + apiPair;
    document.getElementById("signal-title").textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ· " + apiPair + "...";
    document.getElementById("prob").textContent = "";
    document.getElementById("expiry").textContent = "Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: â€“";
    document.getElementById("price").textContent = "Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: â€“";
    document.getElementById("direction").textContent = "ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: â€“";
    document.getElementById("progressBar").style.width = "0%";

    if (!API_BASE) {
      document.getElementById("signal-title").textContent = "âŒ ĞĞµ Ğ·Ğ°Ğ´Ğ°Ğ½ API";
      document.getElementById("prob").textContent = "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ?api=URL_Ğ¢Ğ’ĞĞ•Ğ“Ğ_COLAB";
      return;
    }

    setLoading(true);
    switchTab("signal");

    let data;
    try {
      const url = `${API_BASE}/get_signal?pair=${encodeURIComponent(apiPair)}`;
      const res = await fetch(url, {
        headers: { "ngrok-skip-browser-warning": "true" }
      });

      const raw = await res.text();
      console.log("RAW SIGNAL RESPONSE:", raw);

      try {
        data = JSON.parse(raw);
      } catch (err) {
        // Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€, ĞµÑĞ»Ğ¸ Colab/NGROK Ğ¾Ñ‚Ğ´Ğ°Ğ» HTML/Ñ‚ĞµĞºÑÑ‚
        console.warn("â— ĞĞµ-JSON Ğ¾Ñ‚Ğ²ĞµÑ‚, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ Ñ‡ĞµÑ€ĞµĞ· 300 Ğ¼Ñ");
        await new Promise(r => setTimeout(r, 300));
        const res2 = await fetch(url, {
          headers: { "ngrok-skip-browser-warning": "true" }
        });
        const raw2 = await res2.text();
        console.log("Retry RAW:", raw2);
        data = JSON.parse(raw2);
      }
    } catch (e) {
      console.error("Signal fetch error:", e);
      setLoading(false);
      document.getElementById("signal-title").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°";
      document.getElementById("prob").textContent = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚ Ğ¸Ğ»Ğ¸ API Colab/ngrok.";
      return;
    }

    setLoading(false);

    if (!data || typeof data !== "object") {
      document.getElementById("signal-title").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°";
      document.getElementById("prob").textContent = "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API.";
      return;
    }

    if (data.error) {
      document.getElementById("signal-title").textContent = "âš ï¸ " + data.error;
      document.getElementById("prob").textContent = "";
      showChart(tvSymbol);
      return;
    }

    // ====== ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ³Ğ½Ğ°Ğ» ======
    const dir = (data.direction || data.dir || "NONE").toUpperCase();
    const prob = Number(data.probability ?? data.prob ?? 0);
    const expiryMin = data.expiry;
    const entryPrice = data.entry_price ?? data.entry ?? null;

    const dirEl = document.getElementById("signal-title");
    dirEl.classList.remove("buy", "sell");

    if (dir === "BUY") {
      dirEl.textContent = "ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ÑŒ ğŸŸ¢";
      dirEl.classList.add("buy");
    } else if (dir === "SELL") {
      dirEl.textContent = "ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ğŸ”´";
      dirEl.classList.add("sell");
    } else {
      dirEl.textContent = "âšª Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» ÑĞ»Ğ°Ğ±Ñ‹Ğ¹";
    }

    document.getElementById("prob").textContent =
      "Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ: " + prob.toFixed(0) + "%";

    if (expiryMin == null || expiryMin === 0) {
      document.getElementById("expiry").textContent = "Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: â€“";
      document.getElementById("progressBar").style.width = "0%";
    } else {
      document.getElementById("expiry").textContent =
        "Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: " + expiryMin + " Ğ¼Ğ¸Ğ½";
      const width = Math.max(5, Math.min(100, (expiryMin / 30) * 100));
      document.getElementById("progressBar").style.width = width + "%";
    }

    if (entryPrice != null) {
      document.getElementById("price").textContent =
        "Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: " + Number(entryPrice).toFixed(5);
    }
    document.getElementById("direction").textContent =
      "ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: " + dir;

    showChart(tvSymbol);
    loadSignals(tvSymbol);
    loadStats(tvSymbol);
  }

  // ====== TradingView ======
  // function showChart(symbol) {
  //   const container = document.getElementById("chart-container");
  //   if (!container) return;

  //   if (tvWidget) {
  //     tvWidget.setSymbol(symbol);
  //     return;
  //   }

  //   tvWidget = new TradingView.widget({
  //     autosize: true,
  //     symbol: symbol,
  //     interval: "1",
  //     timezone: "Etc/UTC",
  //     theme: "dark",
  //     style: "1",
  //     hide_top_toolbar: false,
  //     hide_legend: false,
  //     container_id: "chart-container",
  //   });
  // }
     function showChart(symbol, entryPrice = null, dir = null) {
      const container = document.getElementById("chart-container");
      if (!container) return;
    
      // === 1. Ğ•ÑĞ»Ğ¸ TradingView ÑƒĞ¶Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» ===
      if (tvWidget && typeof tvWidget.chart === "function") {
        try {
          tvWidget.chart().setSymbol(symbol);
    
          // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑÑ‚Ñ€ĞµĞ»ĞºĞ° â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¼ĞµĞ½Ñ‹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°
          if (entryPrice && !isNaN(parseFloat(entryPrice))) {
            tvWidget.onChartReady(() => {
              try {
                tvWidget.chart().createMultipointShape(
                  [{ price: parseFloat(entryPrice) }],
                  {
                    shape: dir === "SELL" ? "arrow_down" : "arrow_up",
                    text: dir || "",
                    lock: true,
                    disableSelection: true
                  }
                );
              } catch (e) {
                console.warn("Arrow error:", e);
              }
            });
          }
          return;
        } catch (e) {
          console.warn("setSymbol error:", e);
        }
      }
    
      // === 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· ===
      container.innerHTML = "";
    
      try {
        tvWidget = new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: "1",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "ru",
          hide_top_toolbar: false,
          hide_legend: false,
          container_id: "chart-container",
        });
      } catch (e) {
        console.warn("TradingView init error:", e);
        return;
      }
    
      // === 3. ĞŸĞ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€ĞµĞ»ĞºÑƒ ===
      if (entryPrice && !isNaN(parseFloat(entryPrice))) {
        tvWidget.onChartReady(() => {
          try {
            tvWidget.chart().createMultipointShape(
              [{ price: parseFloat(entryPrice) }],
              {
                shape: dir === "SELL" ? "arrow_down" : "arrow_up",
                text: dir || "",
                lock: true,
                disableSelection: true
              }
            );
          } catch (e) {
            console.warn("Arrow add error:", e);
          }
        });
      }
    }

     
  //   function showChart(symbol) {
  //   const container = document.getElementById("chart-container");
  //   if (!container) return;
  
  //   // === 1. Ğ•ÑĞ»Ğ¸ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº ÑƒĞ¶Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ â†’ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» ===
  //   if (tvWidget && typeof tvWidget.chart === "function") {
  //     try {
  //       tvWidget.chart().setSymbol(symbol);
  //       return;
  //     } catch (e) {
  //       console.warn("setSymbol error:", e);
  //     }
  //   }
  
  //   // === 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· ===
  //   container.innerHTML = "";
  
  //   try {
  //     tvWidget = new TradingView.widget({
  //       autosize: true,
  //       symbol: symbol,
  //       interval: "1",
  //       timezone: "Etc/UTC",
  //       theme: "dark",
  //       style: "1",
  //       hide_top_toolbar: false,
  //       hide_legend: false,
  //       container_id: "chart-container",
  //     });
  //   } catch (e) {
  //     console.warn("TradingView init error:", e);
  //   }
  // }


  // ====== Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² ======
  async function loadSignals(tvSymbol) {
  if (!API_BASE) return;
  try {
    const res = await fetch(`${API_BASE}/signals?symbol=${tvSymbol}`, {
      headers: { "ngrok-skip-browser-warning": "true" }
    });

    let data;
    try { data = await res.json(); }
    catch { console.warn("History JSON error"); return; }

    const div = document.getElementById("signals");
    div.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      div.innerHTML = "<p class='muted'>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²</p>";
      return;
    }

    data.slice(-30).reverse().forEach(s => {
      const el = document.createElement("div");
      el.className = "signal-row " + (s.direction === "BUY" ? "buy" : "sell");
      el.innerHTML = `
        <div class="signal-main">
          <span class="signal-time">${s.time || ""}</span>
          <span class="signal-dir">${s.direction || ""}</span>
        </div>
        <div class="signal-reason">${s.reason || ""}</div>
      `;
      div.appendChild(el);
    });

  } catch (e) {
    console.warn("History error:", e);
  }
}

  // ====== Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ======
  async function loadStats(tvSymbol) {
    if (!API_BASE) return;
    try {
      const res = await fetch(
        `${API_BASE}/stats?symbol=${encodeURIComponent(tvSymbol)}`,
        { headers: { "ngrok-skip-browser-warning": "true" } }
      );
      const data = await res.json();

      if (!data || typeof data !== "object") {
        console.warn("Bad stats payload", data);
        return;
      }

      const total   = data.total   ?? 0;
      const wins    = data.wins    ?? 0;
      const losses  = data.losses  ?? 0;
      const buy     = data.buy     ?? 0;
      const sell    = data.sell    ?? 0;
      const winrate = data.winrate ?? 0;
      const avgProb = data.avg_prob ?? 0;
      const last    = data.last_active || "â€“";

      document.getElementById("stat-total").textContent    = total;
      document.getElementById("stat-wins").textContent     = wins;
      document.getElementById("stat-losses").textContent   = losses;
      document.getElementById("stat-buy").textContent      = buy;
      document.getElementById("stat-sell").textContent     = sell;
      document.getElementById("stat-winrate").textContent  = winrate + "%";
      document.getElementById("stat-avg-prob").textContent = avgProb + "%";
      document.getElementById("stat-last").textContent     = last;

      const winBar  = document.getElementById("stat-win-bar");
      const lossBar = document.getElementById("stat-loss-bar");
      let winPerc = 0, lossPerc = 0;
      if (wins + losses > 0) {
        winPerc  = (wins  / (wins + losses)) * 100;
        lossPerc = (losses / (wins + losses)) * 100;
      }
      winBar.style.width  = winPerc  + "%";
      lossBar.style.width = lossPerc + "%";
    } catch (e) {
      console.error("Stats error:", e);
    }
  }

  // ====== Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ======
  window.addEventListener("load", () => {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + apiPair;
    showChart(tvSymbol);
    loadStats(tvSymbol);
  });

  document.getElementById("pair").addEventListener("change", () => {
    const { tvSymbol, apiPair } = getCurrentPair();
    document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + apiPair;
    showChart(tvSymbol);
    loadStats(tvSymbol);
    loadSignals(tvSymbol);
  });
</script>

<!-- ĞŸĞ»Ğ°Ğ²Ğ°ÑÑ‰Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° -->
<button id="signalButton" class="floating-signal-btn" onclick="updateSignal()">
  ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»
</button>

</body>
</html>
