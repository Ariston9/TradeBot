<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>TradeBot WebApp v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style_v3.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <h1>ğŸ“Š Trade Assistant</h1>
        <p class="subtitle">Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ñ Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° + Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº TradingView</p>
      </div>
      <div class="status-pill" id="statusPill">API: Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾</div>
    </header>

    <!-- Ğ‘Ğ»Ğ¾Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¿Ğ°Ñ€Ñ‹ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ° -->
    <section class="card top-card">
      <div class="pair-row">
        <div class="pair-select-block">
          <label for="pair">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ²Ğ°Ğ»ÑÑ‚Ğ½ÑƒÑ Ğ¿Ğ°Ñ€Ñƒ:</label>
          <select id="pair">
            <!-- EUR pairs -->
            <option value="EURUSD" data-api="EUR/USD">ğŸ‡ªğŸ‡º EUR/USD ğŸ‡ºğŸ‡¸</option>
            <option value="EURGBP" data-api="EUR/GBP">ğŸ‡ªğŸ‡º EUR/GBP ğŸ‡¬ğŸ‡§</option>
            <option value="EURAUD" data-api="EUR/AUD">ğŸ‡ªğŸ‡º EUR/AUD ğŸ‡¦ğŸ‡º</option>
            <option value="EURJPY" data-api="EUR/JPY">ğŸ‡ªğŸ‡º EUR/JPY ğŸ‡¯ğŸ‡µ</option>
            <option value="EURCHF" data-api="EUR/CHF">ğŸ‡ªğŸ‡º EUR/CHF ğŸ‡¨ğŸ‡­</option>
            <option value="EURCAD" data-api="EUR/CAD">ğŸ‡ªğŸ‡º EUR/CAD ğŸ‡¨ğŸ‡¦</option>

            <!-- GBP pairs -->
            <option value="GBPUSD" data-api="GBP/USD">ğŸ‡¬ğŸ‡§ GBP/USD ğŸ‡ºğŸ‡¸</option>
            <option value="GBPJPY" data-api="GBP/JPY">ğŸ‡¬ğŸ‡§ GBP/JPY ğŸ‡¯ğŸ‡µ</option>
            <option value="GBPCHF" data-api="GBP/CHF">ğŸ‡¬ğŸ‡§ GBP/CHF ğŸ‡¨ğŸ‡­</option>
            <option value="GBPAUD" data-api="GBP/AUD">ğŸ‡¬ğŸ‡§ GBP/AUD ğŸ‡¦ğŸ‡º</option>
            <option value="GBPCAD" data-api="GBP/CAD">ğŸ‡¬ğŸ‡§ GBP/CAD ğŸ‡¨ğŸ‡¦</option>

            <!-- USD pairs -->
            <option value="USDJPY" data-api="USD/JPY">ğŸ‡ºğŸ‡¸ USD/JPY ğŸ‡¯ğŸ‡µ</option>
            <option value="USDCAD" data-api="USD/CAD">ğŸ‡ºğŸ‡¸ USD/CAD ğŸ‡¨ğŸ‡¦</option>
            <option value="USDCHF" data-api="USD/CHF">ğŸ‡ºğŸ‡¸ USD/CHF ğŸ‡¨ğŸ‡­</option>

            <!-- AUD pairs -->
            <option value="AUDUSD" data-api="AUD/USD">ğŸ‡¦ğŸ‡º AUD/USD ğŸ‡ºğŸ‡¸</option>
            <option value="AUDJPY" data-api="AUD/JPY">ğŸ‡¦ğŸ‡º AUD/JPY ğŸ‡¯ğŸ‡µ</option>
            <option value="AUDCHF" data-api="AUD/CHF">ğŸ‡¦ğŸ‡º AUD/CHF ğŸ‡¨ğŸ‡­</option>
            <option value="AUDCAD" data-api="AUD/CAD">ğŸ‡¦ğŸ‡º AUD/CAD ğŸ‡¨ğŸ‡¦</option>

            <!-- CAD pairs -->
            <option value="CADJPY" data-api="CAD/JPY">ğŸ‡¨ğŸ‡¦ CAD/JPY ğŸ‡¯ğŸ‡µ</option>
            <option value="CADCHF" data-api="CAD/CHF">ğŸ‡¨ğŸ‡¦ CAD/CHF ğŸ‡¨ğŸ‡­</option>
          </select>
        </div>

        <button id="signalButton" class="btn-primary" onclick="updateSignal()">
          ğŸ”„ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»
        </button>
      </div>

      <p class="hint">
        Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹? Ğ’ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¸ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ½Ğ° Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞµ.
      </p>
    </section>

    <!-- Ğ¢Ğ°Ğ±Ñ‹ -->
    <div class="tabs">
      <button class="tab-button active" data-tab="signal" onclick="switchTab('signal')">
        âš¡ Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»
      </button>
      <button class="tab-button" data-tab="history" onclick="switchTab('history')">
        ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ´ĞµĞ»Ğ¾Ğº
      </button>
    </div>

    <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» -->
    <section id="tab-signal" class="tab-content active">
      <div class="card" id="signalCard" style="display:none;">
        <h3 id="dir" class="signal-direction"></h3>

        <p id="prob" class="signal-prob"></p>

        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>

        <p id="expiry" class="signal-extra"></p>
        <p id="price" class="signal-extra"></p>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <span id="chartTitle">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº TradingView</span>
        </div>
        <div id="chart-container" class="chart-container"></div>
      </div>
    </section>

    <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ -->
    <section id="tab-history" class="tab-content">
      <div class="card">
        <h3>ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğµ</h3>
        <div id="signals" class="signals-list">
          <p class="muted">ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Â», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Telegram & TradingView -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://s3.tradingview.com/tv.js" type="text/javascript"></script>

  <script>
    const tg = window.Telegram.WebApp;
    if (tg && tg.expand) tg.expand();

    let tvWidget = null;

    function getApiBase() {
      const params = new URLSearchParams(window.location.search);
      const apiFromParam = params.get("api");
      const apiBase = apiFromParam || "https://tradebot-production-74c0.up.railway.app";
      const pill = document.getElementById("statusPill");
      pill.textContent = apiFromParam ? "API: Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°" : "API: Railway Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ";
      pill.classList.add(apiFromParam ? "status-ok" : "status-warn");
      return apiBase;
    }

    const API_BASE = getApiBase();

    function switchTab(tab) {
      const buttons = document.querySelectorAll(".tab-button");
      const contents = document.querySelectorAll(".tab-content");

      buttons.forEach(btn => {
        if (btn.dataset.tab === tab) btn.classList.add("active");
        else btn.classList.remove("active");
      });

      contents.forEach(block => {
        block.id === "tab-" + tab
          ? block.classList.add("active")
          : block.classList.remove("active");
      });
    }

    function setLoading(isLoading) {
      const btn = document.getElementById("signalButton");
      const ids = ["dir", "prob", "expiry", "price"];

      if (isLoading) {
        btn.classList.add("btn-loading");
        btn.textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ·...";
        ids.forEach(id => {
          const el = document.getElementById(id);
          el.classList.add("skeleton");
          el.classList.remove("fade-in");
        });
        document.getElementById("progressBar").style.width = "0%";
      } else {
        btn.classList.remove("btn-loading");
        btn.textContent = "ğŸ”„ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»";
        ids.forEach(id => {
          const el = document.getElementById(id);
          el.classList.remove("skeleton");
          el.classList.add("fade-in");
        });
      }
    }

    async function updateSignal() {
      const select = document.getElementById("pair");
      const opt = select.options[select.selectedIndex];
      const tvSymbol = opt.value;          // EURUSD
      const pairForApi = opt.dataset.api;  // EUR/USD

      document.getElementById("signalCard").style.display = "block";
      document.getElementById("dir").textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ· " + pairForApi + "...";
      document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + pairForApi;

      setLoading(true);
      switchTab("signal");

      if (!API_BASE) {
        setLoading(false);
        document.getElementById("dir").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: API Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½.";
        return;
      }

      const url = `${API_BASE}/get_signal?pair=${encodeURIComponent(pairForApi)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        setLoading(false);

        if (data.error) {
          document.getElementById("dir").textContent = "âš ï¸ Ğ Ñ‹Ğ½Ğ¾Ğº Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚";
          document.getElementById("prob").textContent = data.error;
          document.getElementById("expiry").textContent = "";
          document.getElementById("price").textContent = "";
          document.getElementById("progressBar").style.width = "0%";
          showChart(tvSymbol);
          return;
        }

        // ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
        const dirEl = document.getElementById("dir");
        if (data.dir === "BUY") {
          dirEl.textContent = "ğŸ“ˆ ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ÑŒ";
          dirEl.classList.add("buy");
          dirEl.classList.remove("sell");
        } else if (data.dir === "SELL") {
          dirEl.textContent = "ğŸ”» ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ";
          dirEl.classList.add("sell");
          dirEl.classList.remove("buy");
        } else {
          dirEl.textContent = "âšª Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» ÑĞ»Ğ°Ğ±Ñ‹Ğ¹";
          dirEl.classList.remove("buy", "sell");
        }

        // Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ + Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€
        const prob = data.prob || 0;
        document.getElementById("prob").textContent = `ğŸ¯ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ: ${prob}%`;
        document.getElementById("progressBar").style.width = Math.max(0, Math.min(100, prob)) + "%";

        // Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ†ĞµĞ½Ğ°
        document.getElementById("expiry").textContent =
          data.expiry ? `â± Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: ${data.expiry} Ğ¼Ğ¸Ğ½` : "";
        document.getElementById("price").textContent =
          data.entry_price ? `ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: ${data.entry_price}` : "";

        showChart(tvSymbol, data.entry_price, data.dir);
        loadSignals(tvSymbol);

      } catch (e) {
        console.error(e);
        setLoading(false);
        document.getElementById("dir").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….";
      }
    }

    function showChart(tvSymbol, entryPrice = null, dir = null) {
      document.getElementById("chart-container").innerHTML = "";

      tvWidget = new TradingView.widget({
        autosize: true,
        symbol: "FX:" + tvSymbol,
        interval: "1",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        container_id: "chart-container",
      });

      if (entryPrice && !isNaN(parseFloat(entryPrice))) {
        tvWidget.onChartReady(function () {
          const chart = tvWidget.chart();
          chart.createMultipointShape(
            [{ price: parseFloat(entryPrice) }],
            {
              shape: dir === "SELL" ? "arrow_down" : "arrow_up",
              text: dir || "",
              lock: true,
              disableSelection: true,
            }
          );
        });
      }
    }

    async function loadSignals(tvSymbol) {
      if (!API_BASE) return;

      try {
        const res = await fetch(`${API_BASE}/signals?symbol=${tvSymbol}`);
        const data = await res.json();
        const div = document.getElementById("signals");
        div.innerHTML = "";

        const list = Array.isArray(data) ? data.slice(-20).reverse() : [];

        if (!list.length) {
          div.innerHTML = "<p class='muted'>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¿Ğ¾ ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğµ.</p>";
          return;
        }

        list.forEach(s => {
          const el = document.createElement("div");
          el.className = "signal-row " + (s.direction === "BUY" ? "buy" : "sell");
          el.innerHTML = `
            <div class="signal-main">
              <span class="signal-time">${s.time || ""}</span>
              <span class="signal-dir">${s.direction}</span>
            </div>
            <div class="signal-reason">${s.reason || ""}</div>
          `;
          div.appendChild(el);
        });
      } catch (e) {
        console.error(e);
      }
    }

    // ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑÑ€Ğ°Ğ·Ñƒ Ñ€Ğ¸ÑÑƒĞµĞ¼ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğµ
    window.addEventListener("load", () => {
      const select = document.getElementById("pair");
      const opt = select.options[select.selectedIndex];
      document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + opt.dataset.api;
      showChart(opt.value);
    });
  </script>
</body>
</html>
