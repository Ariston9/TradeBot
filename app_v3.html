<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Trade Assistant WebApp v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style_v3.css" />
</head>
<body>
<div class="app">

  <!-- ======= Ğ¥Ğ•Ğ”Ğ•Ğ  ======= -->
  <header class="app-header">
    <div class="header-left">
      <div class="header-logo"></div>
      <div class="header-text">
        <div class="header-title">Trade Assistant</div>
        <div class="header-subtitle">ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ² Ñ‚Ñ€ĞµĞ¹Ğ´Ğ¸Ğ½Ğ³Ğµ</div>
      </div>
    </div>

    <div class="header-right">
      <div class="api-pill" id="statusPill">API: Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾</div>

      <label class="pair-label" for="pair">Ğ’Ğ°Ğ»ÑÑ‚Ğ½Ğ°Ñ Ğ¿Ğ°Ñ€Ğ°</label>
      <select id="pair" class="pair-select">
        <!-- EUR pairs -->
        <option value="EURUSD" data-api="EUR/USD">ğŸ‡ªğŸ‡º EUR/USD ğŸ‡ºğŸ‡¸</option>
        <option value="EURGBP" data-api="EUR/GBP">ğŸ‡ªğŸ‡º EUR/GBP ğŸ‡¬ğŸ‡§</option>
        <option value="EURAUD" data-api="EUR/AUD">ğŸ‡ªğŸ‡º EUR/AUD ğŸ‡¦ğŸ‡º</option>
        <option value="EURJPY" data-api="EUR/JPY">ğŸ‡ªğŸ‡º EUR/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="EURCHF" data-api="EUR/CHF">ğŸ‡ªğŸ‡º EUR/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="EURCAD" data-api="EUR/CAD">ğŸ‡ªğŸ‡º EUR/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- GBP pairs -->
        <option value="GBPUSD" data-api="GBP/USD">ğŸ‡¬ğŸ‡§ GBP/USD ğŸ‡ºğŸ‡¸</option>
        <option value="GBPJPY" data-api="GBP/JPY">ğŸ‡¬ğŸ‡§ GBP/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="GBPCHF" data-api="GBP/CHF">ğŸ‡¬ğŸ‡§ GBP/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="GBPAUD" data-api="GBP/AUD">ğŸ‡¬ğŸ‡§ GBP/AUD ğŸ‡¦ğŸ‡º</option>
        <option value="GBPCAD" data-api="GBP/CAD">ğŸ‡¬ğŸ‡§ GBP/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- USD pairs -->
        <option value="USDJPY" data-api="USD/JPY">ğŸ‡ºğŸ‡¸ USD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="USDCAD" data-api="USD/CAD">ğŸ‡ºğŸ‡¸ USDCAD ğŸ‡¨ğŸ‡¦</option>
        <option value="USDCHF" data-api="USD/CHF">ğŸ‡ºğŸ‡¸ USD/CHF ğŸ‡¨ğŸ‡­</option>

        <!-- AUD pairs -->
        <option value="AUDUSD" data-api="AUD/USD">ğŸ‡¦ğŸ‡º AUD/USD ğŸ‡ºğŸ‡¸</option>
        <option value="AUDJPY" data-api="AUD/JPY">ğŸ‡¦ğŸ‡º AUD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="AUDCHF" data-api="AUD/CHF">ğŸ‡¦ğŸ‡º AUD/CHF ğŸ‡¨ğŸ‡­</option>
        <option value="AUDCAD" data-api="AUD/CAD">ğŸ‡¦ğŸ‡º AUD/CAD ğŸ‡¨ğŸ‡¦</option>

        <!-- CAD pairs -->
        <option value="CADJPY" data-api="CAD/JPY">ğŸ‡¨ğŸ‡¦ CAD/JPY ğŸ‡¯ğŸ‡µ</option>
        <option value="CADCHF" data-api="CAD/CHF">ğŸ‡¨ğŸ‡¦ CAD/CHF ğŸ‡¨ğŸ‡­</option>
      </select>
    </div>
  </header>

  <!-- ======= ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•ĞĞ¢ ======= -->
  <main class="app-main">

    <!-- === Ğ’ĞšĞ›ĞĞ”ĞšĞ Ğ¡Ğ˜Ğ“ĞĞĞ› === -->
    <section id="tab-signal" class="tab-content active">
      <div class="card">

        <div class="signal-header-row">
          <div>
            <div id="signal-title" class="signal-direction">â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°...</div>
            <div id="prob" class="signal-prob muted">ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Â»</div>
          </div>
        </div>

        <div class="signal-extra-row">
          <div id="expiry" class="signal-extra">Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: â€“</div>
          <div id="price" class="signal-extra">Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: â€“</div>
          <div id="direction" class="signal-extra">ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: â€“</div>
        </div>

        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <span id="chartTitle">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: EUR/USD</span>
        </div>
        <div id="chart-container" class="chart-container"></div>
      </div>
    </section>

    <!-- === Ğ’ĞšĞ›ĞĞ”ĞšĞ Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ === -->
    <section id="tab-history" class="tab-content">
      <div class="card">
        <h3>ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²</h3>
        <p class="muted small">ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ¿Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğµ.</p>
        <div id="signals" class="signals-list">
          <p class="muted">ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Â», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ.</p>
        </div>
      </div>
    </section>

    <!-- === Ğ’ĞšĞ›ĞĞ”ĞšĞ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ === -->
    <section id="tab-stats" class="tab-content">
      <div class="card">
        <h3>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğµ</h3>
        <p class="muted small">ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°Ğ¼ Ğ±Ğ¾Ñ‚Ğ°.</p>

        <div class="stats-grid">
          <div class="stats-item"><div class="stats-label">Ğ’ÑĞµĞ³Ğ¾:</div><div id="stat-total" class="stats-value">â€“</div></div>
          <div class="stats-item"><div class="stats-label">WIN:</div><div id="stat-wins" class="stats-value win">â€“</div></div>
          <div class="stats-item"><div class="stats-label">LOSS:</div><div id="stat-losses" class="stats-value loss">â€“</div></div>
          <div class="stats-item"><div class="stats-label">WinRate:</div><div id="stat-winrate" class="stats-value">â€“</div></div>
          <div class="stats-item"><div class="stats-label">BUY:</div><div id="stat-buy" class="stats-value">â€“</div></div>
          <div class="stats-item"><div class="stats-label">SELL:</div><div id="stat-sell" class="stats-value">â€“</div></div>
          <div class="stats-item"><div class="stats-label">AvgProb:</div><div id="stat-avg-prob" class="stats-value">â€“</div></div>
          <div class="stats-item"><div class="stats-label">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ:</div><div id="stat-last" class="stats-value small">â€“</div></div>
        </div>
      </div>
    </section>

    <!-- === ĞĞ’Ğ¢ĞĞ¡ĞšĞĞ === -->
    <section id="tab-autoscan" class="tab-content">
      <div class="card">
        <h3>ğŸ”„ ĞĞ²Ñ‚Ğ¾ÑĞºĞ°Ğ½</h3>
        <p class="muted small">Ğ¢ÑƒÑ‚ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ğ²Ñ‚Ğ¾ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹.</p>
        <div id="autoscan-info" class="autoscan-box">
          <p class="muted">ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾.</p>
        </div>
      </div>
    </section>

  </main>

  <!-- ======= ĞĞ˜Ğ–ĞĞ•Ğ• ĞœĞ•ĞĞ® ======= -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="signal" onclick="switchTab('signal')">
      <img class="nav-icon" src="icons/Signal.svg" />
      <span class="nav-label">Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»</span>
    </button>
    <button class="nav-item" data-tab="history" onclick="switchTab('history')">
      <img class="nav-icon" src="icons/History.svg" />
      <span class="nav-label">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</span>
    </button>
    <button class="nav-item" data-tab="stats" onclick="switchTab('stats')">
      <img class="nav-icon" src="icons/Statistics.svg" />
      <span class="nav-label">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</span>
    </button>
    <button class="nav-item" data-tab="autoscan" onclick="switchTab('autoscan')">
      <img class="nav-icon" src="icons/Autoscan.svg" />
      <span class="nav-label">ĞĞ²Ñ‚Ğ¾ÑĞºĞ°Ğ½</span>
    </button>
  </nav>

</div>


<!-- Telegram & TradingView -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<script>

/* ========== Telegram WebApp ========== */
const tg = window.Telegram?.WebApp;
if (tg?.expand) tg.expand();

/* ========== API BASE from ?api= ========== */
function getApiBase() {
  const pill = document.getElementById("statusPill");
  const urlParams = new URLSearchParams(window.location.search);
  const api = urlParams.get("api");
  if (!api) {
    pill.textContent = "API: Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½";
    pill.classList.add("status-warn");
    return "";
  }
  pill.textContent = "API: Colab/ngrok";
  pill.classList.add("status-ok");
  return api.replace(/\/+$/, "");
}

let API_BASE = getApiBase();

/* =======================================================================
      Helper: Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ JSON Ñ retry (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ HTML/Ğ¾Ğ±Ñ€Ñ‹Ğ²Ğ¾Ğ² ngrok)
======================================================================= */
async function safeJson(url, retries = 1) {
  const res = await fetch(url, { headers: { "ngrok-skip-browser-warning": "true" }});
  const raw = await res.text();
  console.log("RAW:", raw);

  try { return JSON.parse(raw); }
  catch {
    if (retries <= 0) throw new Error("JSON parse failed: " + raw);
    console.warn("Retrying JSON parseâ€¦");
    await new Promise(r => setTimeout(r, 250));
    return safeJson(url, retries - 1);
  }
}

/* =======================================================================
      TradingView â€” Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Telegram WebView
======================================================================= */
let tvWidget = null;

function safeChartInit(tvSymbol, entryPrice = null, dir = null) {
  const container = document.getElementById("chart-container");
  container.innerHTML = "";

  try {
    tvWidget = new TradingView.widget({
      autosize: true,
      symbol: "FX:" + tvSymbol,
      interval: "1",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "ru",
      container_id: "chart-container",
    });
  } catch (e) {
    console.warn("TradingView init error:", e);
    return;
  }

  if (entryPrice && !isNaN(parseFloat(entryPrice))) {
    tvWidget.onChartReady(() => {
      try {
        tvWidget.chart().createMultipointShape(
          [{ price: parseFloat(entryPrice) }],
          {
            shape: dir === "SELL" ? "arrow_down" : "arrow_up",
            text: dir || "",
            lock: true,
            disableSelection: true
          }
        );
      } catch (e) {
        console.warn("Arrow place error:", e);
      }
    });
  }
}

/* =======================================================================
      ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ° â€” Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ
======================================================================= */
function getCurrentPair() {
  const sel = document.getElementById("pair");
  const opt = sel.options[sel.selectedIndex];
  return { tvSymbol: opt.value, apiPair: opt.dataset.api };
}

function setLoading(b) {
  const btn = document.getElementById("signalButton");
  if (!btn) return;
  btn.textContent = b ? "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ·..." : "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»";
  btn.classList.toggle("btn-loading", b);
}

async function updateSignal() {
  const { tvSymbol, apiPair } = getCurrentPair();

  document.getElementById("signal-title").textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ· " + apiPair + "...";
  document.getElementById("prob").textContent = "";
  document.getElementById("expiry").textContent = "Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: â€“";
  document.getElementById("price").textContent = "Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: â€“";
  document.getElementById("direction").textContent = "ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: â€“";
  document.getElementById("progressBar").style.width = "0%";

  if (!API_BASE) {
    document.getElementById("signal-title").textContent = "âŒ API Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½";
    document.getElementById("prob").textContent = "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ?api= Ğ² URL";
    return;
  }

  setLoading(true);

  const url = `${API_BASE}/get_signal?pair=${encodeURIComponent(apiPair)}`;

  try {
    const data = await safeJson(url, 1);

    if (!data || typeof data !== "object" || !("dir" in data)) {
      throw new Error("Bad signal structure");
    }

    /* ==== ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ£Ğ¡ĞŸĞ•Ğ¥Ğ• ==== */
    const dir = data.dir;
    const prob = data.prob || 0;

    const title = document.getElementById("signal-title");
    title.classList.remove("buy","sell");

    if (dir === "BUY") { title.textContent = "ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ÑŒ ğŸŸ¢"; title.classList.add("buy"); }
    else if (dir === "SELL") { title.textContent = "ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ğŸ”´"; title.classList.add("sell"); }
    else title.textContent = "âšª Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ÑĞ¸Ğ³Ğ½Ğ°Ğ»";

    document.getElementById("direction").textContent = "ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: " + (dir || "â€“");
    document.getElementById("prob").textContent = `ğŸ¯ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ: ${prob}%`;
    document.getElementById("progressBar").style.width = Math.min(prob,100) + "%";

    if (dir === "NONE") {
      document.getElementById("expiry").textContent = "Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ÑĞ¸Ğ³Ğ½Ğ°Ğ»";
    } else if (data.expiry) {
      document.getElementById("expiry").textContent = `Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: ${data.expiry} Ğ¼Ğ¸Ğ½`;
    }

    if (data.entry_price) {
      document.getElementById("price").textContent = `Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: ${data.entry_price}`;
    }

    /* ==== TradingView Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ ==== */
    safeChartInit(tvSymbol, data.entry_price, data.dir);

    /* ==== Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ĞĞ• Ğ»Ğ¾Ğ¼Ğ°ÑÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ» ==== */
    setTimeout(() => loadSignals(tvSymbol).catch(e => console.warn("signals:",e)), 100);
    setTimeout(() => loadStats(tvSymbol).catch(e => console.warn("stats:",e)), 200);

    setLoading(false);
    return;

  } catch (e) {
    console.warn("updateSignal non-critical error:", e);
    setLoading(false);

    // â— Ğ’Ğ°Ğ¶Ğ½Ğ¾: ĞµÑĞ»Ğ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ» ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ» Ğ½Ğ°Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ğ½, ĞĞ• Ğ—ĞĞ¢Ğ˜Ğ ĞĞ•Ğœ UI!!
    const current = document.getElementById("direction").textContent;
    if (current.includes("BUY") || current.includes("SELL") || current.includes("â€“") === false) {
      return; // UI ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ğ½ â€” ĞĞ• ĞœĞ•ĞĞ¯Ğ•Ğœ ĞĞ˜Ğ§Ğ•Ğ“Ğ
    }

    document.getElementById("signal-title").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°";
    document.getElementById("prob").textContent = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ API Colab/ngrok";
  }
}

/* =======================================================================
      Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
======================================================================= */
async function loadSignals(tvSymbol) {
  if (!API_BASE) return;
  try {
    const res = await fetch(`${API_BASE}/signals?symbol=${tvSymbol}`, {
      headers: { "ngrok-skip-browser-warning": "true" }
    });

    let data;
    try { data = await res.json(); }
    catch { console.warn("History JSON error"); return; }

    const div = document.getElementById("signals");
    div.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      div.innerHTML = "<p class='muted'>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²</p>";
      return;
    }

    data.slice(-30).reverse().forEach(s => {
      const el = document.createElement("div");
      el.className = "signal-row " + (s.direction === "BUY" ? "buy" : "sell");
      el.innerHTML = `
        <div class="signal-main">
          <span class="signal-time">${s.time || ""}</span>
          <span class="signal-dir">${s.direction || ""}</span>
        </div>
        <div class="signal-reason">${s.reason || ""}</div>
      `;
      div.appendChild(el);
    });

  } catch (e) {
    console.warn("History error:", e);
  }
}

/* =======================================================================
      Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
======================================================================= */
async function loadStats(tvSymbol) {
  if (!API_BASE) return;
  try {
    const res = await fetch(`${API_BASE}/stats?symbol=${tvSymbol}`, {
      headers: { "ngrok-skip-browser-warning": "true" }
    });

    let data;
    try { data = await res.json(); }
    catch { console.warn("Stats JSON error"); return; }

    document.getElementById("stat-total").textContent = data.total ?? "â€“";
    document.getElementById("stat-wins").textContent = data.wins ?? "â€“";
    document.getElementById("stat-losses").textContent = data.losses ?? "â€“";
    document.getElementById("stat-buy").textContent = data.buy ?? "â€“";
    document.getElementById("stat-sell").textContent = data.sell ?? "â€“";
    document.getElementById("stat-winrate").textContent = (data.winrate ?? 0) + "%";
    document.getElementById("stat-avg-prob").textContent = (data.avg_prob ?? 0) + "%";
    document.getElementById("stat-last").textContent = data.last_active ?? "â€“";

  } catch (e) {
    console.warn("Stats error:", e);
  }
}

/* =======================================================================
      INITIAL LOAD
======================================================================= */
window.addEventListener("load", () => {
  const { tvSymbol, apiPair } = getCurrentPair();
  document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + apiPair;
  safeChartInit(tvSymbol);
  loadStats(tvSymbol);
});

document.getElementById("pair").addEventListener("change", () => {
  const { tvSymbol, apiPair } = getCurrentPair();
  document.getElementById("chartTitle").textContent = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: " + apiPair;
  safeChartInit(tvSymbol);
  setTimeout(() => loadStats(tvSymbol), 50);
  setTimeout(() => loadSignals(tvSymbol), 100);
});

</script>

<button id="signalButton" class="floating-signal-btn" onclick="updateSignal()">
  ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»
</button>

</body>
</html>
