<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Assistant</title>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>ğŸ“Š Trade Assistant</h2>

  <div class="card">
    <label>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ²Ğ°Ğ»ÑÑ‚Ğ½ÑƒÑ Ğ¿Ğ°Ñ€Ñƒ:</label>
    <select id="pair">
      <option>ğŸ‡ªğŸ‡º EUR/USD ğŸ‡ºğŸ‡¸</option>
      <option>ğŸ‡ªğŸ‡º EUR/GBP ğŸ‡¬ğŸ‡§</option>
      <option>ğŸ‡ªğŸ‡º EUR/AUD ğŸ‡¦ğŸ‡º</option>
      <option>ğŸ‡ªğŸ‡º EUR/JPY ğŸ‡¯ğŸ‡µ</option>
      <option>ğŸ‡ªğŸ‡º EUR/CHF ğŸ‡¨ğŸ‡­</option>
      <option>ğŸ‡ªğŸ‡º EUR/CAD ğŸ‡¨ğŸ‡¦</option>

      <option>ğŸ‡¬ğŸ‡§ GBP/USD ğŸ‡ºğŸ‡¸</option>
      <option>ğŸ‡¬ğŸ‡§ GBP/JPY ğŸ‡¯ğŸ‡µ</option>
      <option>ğŸ‡¬ğŸ‡§ GBP/CHF ğŸ‡¨ğŸ‡­</option>
      <option>ğŸ‡¬ğŸ‡§ GBP/AUD ğŸ‡¦ğŸ‡º</option>
      <option>ğŸ‡¬ğŸ‡§ GBP/CAD ğŸ‡¨ğŸ‡¦</option>

      <option>ğŸ‡ºğŸ‡¸ USD/JPY ğŸ‡¯ğŸ‡µ</option>
      <option>ğŸ‡ºğŸ‡¸ USD/CAD ğŸ‡¨ğŸ‡¦</option>
      <option>ğŸ‡ºğŸ‡¸ USD/CHF ğŸ‡¨ğŸ‡­</option>

      <option>ğŸ‡¦ğŸ‡º AUD/USD ğŸ‡ºğŸ‡¸</option>
      <option>ğŸ‡¦ğŸ‡º AUD/JPY ğŸ‡¯ğŸ‡µ</option>
      <option>ğŸ‡¦ğŸ‡º AUD/CHF ğŸ‡¨ğŸ‡­</option>
      <option>ğŸ‡¦ğŸ‡º AUD/CAD ğŸ‡¨ğŸ‡¦</option>

      <option>ğŸ‡¨ğŸ‡¦ CAD/JPY ğŸ‡¯ğŸ‡µ</option>
      <option>ğŸ‡¨ğŸ‡¦ CAD/CHF ğŸ‡¨ğŸ‡­</option>
      <option>ğŸ‡³ğŸ‡¿ NZD/USD ğŸ‡ºğŸ‡¸</option>
    </select>
    <button id="signalButton" onclick="updateSignal()">ğŸ”„ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»</button>
  </div>

  <div class="card" id="signalCard" style="display:none;">
    <h3 id="dir"></h3>
    <p id="prob"></p>

    <div class="progress-bar-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>

    <p id="expiry"></p>
    <p id="price"></p>
  </div>

  <div id="chart-container"></div>

  <div id="signals"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    if (tg && tg.expand) tg.expand();

    let tvWidget = null;

    function setLoading(isLoading) {
      const btn = document.getElementById("signalButton");
      const ids = ["dir", "prob", "expiry", "price"];

      if (isLoading) {
        btn.classList.add("btn-loading");
        ids.forEach(id => {
          const el = document.getElementById(id);
          el.classList.add("skeleton");
          el.classList.remove("fade-in");
        });
        document.getElementById("progressBar").style.width = "0%";
      } else {
        btn.classList.remove("btn-loading");
        ids.forEach(id => {
          const el = document.getElementById(id);
          el.classList.remove("skeleton");
          el.classList.add("fade-in");
        });
      }
    }

    async function updateSignal() {
      const pair = document.getElementById("pair").value;
      document.getElementById("signalCard").style.display = "block";
      document.getElementById("dir").textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ· " + pair + "...";

      setLoading(true);

      const params = new URLSearchParams(window.location.search);
      const apiBase = params.get("api") || "";

      if (!apiBase) {
        setLoading(false);
        document.getElementById("dir").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ api Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½.";
        return;
      }

      const url = `${apiBase}/get_signal?pair=${encodeURIComponent(pair)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        setLoading(false);

        if (data.error) {
          document.getElementById("dir").textContent = "âš ï¸ Ğ Ñ‹Ğ½Ğ¾Ğº Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚";
          document.getElementById("prob").textContent = data.error;
          document.getElementById("expiry").textContent = "";
          document.getElementById("price").textContent = "";
          document.getElementById("progressBar").style.width = "0%";
          return;
        }

        // ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
        if (data.dir === "BUY") {
          document.getElementById("dir").textContent = "ğŸ“ˆ ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ÑŒ";
          document.getElementById("dir").classList.add("buy");
          document.getElementById("dir").classList.remove("sell");
        } else if (data.dir === "SELL") {
          document.getElementById("dir").textContent = "ğŸ”» ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ";
          document.getElementById("dir").classList.add("sell");
          document.getElementById("dir").classList.remove("buy");
        } else {
          document.getElementById("dir").textContent = "âšª Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» ÑĞ»Ğ°Ğ±Ñ‹Ğ¹";
          document.getElementById("dir").classList.remove("buy", "sell");
        }

        // Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ + Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€
        const prob = data.prob || 0;
        document.getElementById("prob").textContent = `ğŸ¯ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ: ${prob}%`;
        document.getElementById("progressBar").style.width = prob + "%";

        // Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ†ĞµĞ½Ğ°
        document.getElementById("expiry").textContent =
          data.expiry ? `â± Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: ${data.expiry} Ğ¼Ğ¸Ğ½` : "";
        document.getElementById("price").textContent =
          data.entry_price ? `ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: ${data.entry_price}` : "";

        showChart(pair, data.entry_price, data.dir);
        loadSignals(pair);

      } catch (e) {
        console.error(e);
        setLoading(false);
        document.getElementById("dir").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….";
      }
    }

    function showChart(pair, entryPrice = null, dir = null) {
      document.getElementById("chart-container").innerHTML = "";

      const symbol = pair.replace("/", "");

      tvWidget = new TradingView.widget({
        autosize: true,
        symbol: symbol,
        interval: "1",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        container_id: "chart-container",
      });

      if (entryPrice && !isNaN(parseFloat(entryPrice))) {
        tvWidget.onChartReady(function () {
          const chart = tvWidget.chart();
          chart.createMultipointShape(
            [{ price: parseFloat(entryPrice) }],
            {
              shape: dir === "SELL" ? "arrow_down" : "arrow_up",
              text: dir || "",
              lock: true,
              disableSelection: true,
            }
          );
        });
      }
    }

    async function loadSignals(pair) {
      const params = new URLSearchParams(window.location.search);
      const apiBase = params.get("api") || "";
      if (!apiBase) return;

      try {
        const res = await fetch(`${apiBase}/signals?symbol=${pair.replace("/", "")}`);
        const data = await res.json();
        const div = document.getElementById("signals");
        div.innerHTML = "<h4>ğŸ“ˆ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²:</h4>";
        (data || []).slice(-10).reverse().forEach(s => {
          const el = document.createElement("div");
          el.className = "signal " + (s.direction === "BUY" ? "buy" : "sell");
          el.textContent = `${s.time} â†’ ${s.direction} (${s.reason || ""})`;
          div.appendChild(el);
        });
      } catch (e) {
        console.error(e);
      }
    }
  </script>
</body>
</html>
