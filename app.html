<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trade Assistant</title>

<style>
  body {
    background: #0f172a;
    color: #f8fafc;
    font-family: "Inter", sans-serif;
    padding: 12px;
  }
  .card {
    background: #1e293b;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }
  h2 { margin: 0 0 10px 0; font-size: 18px; }
  select, button {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    margin-top: 6px;
    font-size: 15px;
  }
  button {
    background: #22c55e;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }
  #chart-container {
    margin-top: 12px;
    height: 400px;
  }
  #signals {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    max-height: 160px;
    overflow-y: auto;
  }
  .signal {
    margin: 4px 0;
    padding: 6px;
    border-radius: 6px;
    font-size: 14px;
  }
  .buy { background: rgba(34,197,94,0.2); color: #4ade80; }
  .sell { background: rgba(239,68,68,0.2); color: #f87171; }
</style>
</head>
<body>
  <h2>ğŸ“Š Trade Assistant</h2>

  <div class="card">
   <label>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ²Ğ°Ğ»ÑÑ‚Ğ½ÑƒÑ Ğ¿Ğ°Ñ€Ñƒ:</label>
   <select id="pair">
    <option>ğŸ‡ªğŸ‡º EUR/USD ğŸ‡ºğŸ‡¸</option>
    <option>ğŸ‡ªğŸ‡º EUR/GBP ğŸ‡¬ğŸ‡§</option>
    <option>ğŸ‡ªğŸ‡º EUR/AUD ğŸ‡¦ğŸ‡º</option>
    <option>ğŸ‡ªğŸ‡º EUR/JPY ğŸ‡¯ğŸ‡µ</option>
    <option>ğŸ‡ªğŸ‡º EUR/CHF ğŸ‡¨ğŸ‡­</option>
    <option>ğŸ‡ªğŸ‡º EUR/CAD ğŸ‡¨ğŸ‡¦</option>

    <option>ğŸ‡¬ğŸ‡§ GBP/USD ğŸ‡ºğŸ‡¸</option>
    <option>ğŸ‡¬ğŸ‡§ GBP/JPY ğŸ‡¯ğŸ‡µ</option>
    <option>ğŸ‡¬ğŸ‡§ GBP/CHF ğŸ‡¨ğŸ‡­</option>
    <option>ğŸ‡¬ğŸ‡§ GBP/AUD ğŸ‡¦ğŸ‡º</option>
    <option>ğŸ‡¬ğŸ‡§ GBP/CAD ğŸ‡¨ğŸ‡¦</option>

    <option>ğŸ‡ºğŸ‡¸ USD/JPY ğŸ‡¯ğŸ‡µ</option>
    <option>ğŸ‡ºğŸ‡¸ USD/CAD ğŸ‡¨ğŸ‡¦</option>
    <option>ğŸ‡ºğŸ‡¸ USD/CHF ğŸ‡¨ğŸ‡­</option>

    <option>ğŸ‡¦ğŸ‡º AUD/USD ğŸ‡ºğŸ‡¸</option>
    <option>ğŸ‡¦ğŸ‡º AUD/JPY ğŸ‡¯ğŸ‡µ</option>
    <option>ğŸ‡¦ğŸ‡º AUD/CHF ğŸ‡¨ğŸ‡­</option>
    <option>ğŸ‡¦ğŸ‡º AUD/CAD ğŸ‡¨ğŸ‡¦</option>

    <option>ğŸ‡¨ğŸ‡¦ CAD/JPY ğŸ‡¯ğŸ‡µ</option>
    <option>ğŸ‡¨ğŸ‡¦ CAD/CHF ğŸ‡¨ğŸ‡­</option>
    <option>ğŸ‡³ğŸ‡¿ NZD/USD ğŸ‡ºğŸ‡¸</option>
   </select>
   <button onclick="updateSignal()">ğŸ”„ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»</button>
  </div>

  <div class="card" id="signalCard" style="display:none;">
    <h3 id="dir"></h3>
    <p id="prob"></p>
    <p id="expiry"></p>
    <p id="price"></p>
  </div>

  <div id="chart-container"></div>

  <div id="signals"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    async function updateSignal() {
      const pair = document.getElementById("pair").value;
      document.getElementById("signalCard").style.display = "block";
      document.getElementById("dir").textContent = "â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ· " + pair + "...";

      const params = new URLSearchParams(window.location.search);
      const apiBase = params.get("api") || "";
      const url = `${apiBase}/get_signal?pair=${encodeURIComponent(pair)}`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        document.getElementById("dir").textContent =
          data.dir === "BUY" ? "ğŸ“ˆ ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ÑŒ" :
          data.dir === "SELL" ? "ğŸ”» ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ" : "âšª ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ";

        document.getElementById("prob").textContent = `ğŸ¯ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ: ${data.prob}%`;
        document.getElementById("expiry").textContent =
          data.expiry ? `â± Ğ­ĞºÑĞ¿Ğ¸Ñ€Ğ°Ñ†Ğ¸Ñ: ${data.expiry} Ğ¼Ğ¸Ğ½` : "Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» ÑĞ»Ğ°Ğ±Ñ‹Ğ¹";
        document.getElementById("price").textContent =
          data.entry_price ? `ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°: ${data.entry_price.toFixed(5)}` : "";

        showChart(pair);
        loadSignals(pair);
      } catch (e) {
        document.getElementById("dir").textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….";
      }
    }

    function showChart(pair) {
      document.getElementById("chart-container").innerHTML = "";
      new TradingView.widget({
        autosize: true,
        symbol: pair.replace("/", ""),
        interval: "1",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        container_id: "chart-container"
      });
    }

    async function loadSignals(pair) {
      const params = new URLSearchParams(window.location.search);
      const apiBase = params.get("api") || "";
      try {
        const res = await fetch(`${apiBase}/signals?symbol=${pair.replace("/", "")}`);
        const data = await res.json();
        const div = document.getElementById("signals");
        div.innerHTML = "<h4>ğŸ“ˆ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²:</h4>";
        data.slice(-10).reverse().forEach(s => {
          const el = document.createElement("div");
          el.className = "signal " + (s.direction === "BUY" ? "buy" : "sell");
          el.textContent = `${s.time} â†’ ${s.direction} (${s.reason})`;
          div.appendChild(el);
        });
      } catch (e) {
        console.error(e);
      }
    }
  </script>
</body>
</html>
