<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Trade Assistant WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="style.css" />

  <!-- TradingView -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <span class="logo-emoji">üìä</span>
      <span class="logo-text">Trade Assistant</span>
    </div>
    <div class="header-right">
      <select id="pairSelect" class="pair-select"></select>
    </div>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('signalTab', this)">–°–∏–≥–Ω–∞–ª</button>
    <button class="tab" onclick="switchTab('historyTab', this)">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</button>
  </div>

  <!-- SIGNAL TAB -->
  <div id="signalTab">

    <!-- CHART -->
    <section class="card" id="chartCard">
      <div class="card-title">–ì—Ä–∞—Ñ–∏–∫ TradingView</div>
      <div id="chartContainer"></div>
    </section>

    <!-- SIGNAL CARD -->
    <section class="card" id="signalCard">
      <div class="signal-header">
        <div class="pair-label" id="pairLabel">‚Äì</div>
        <div class="signal-dir" id="signalType">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞...</div>
      </div>

      <div class="signal-row">
        <span class="signal-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</span>
        <span class="signal-value" id="signalProb">‚Äì</span>
      </div>

      <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>

      <div class="signal-row">
        <span class="signal-label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</span>
        <span class="signal-value" id="signalPrice">‚Äì</span>
      </div>

      <div class="signal-row">
        <span class="signal-label">–≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è:</span>
        <span class="signal-value" id="signalExpiry">‚Äì</span>
      </div>

      <div class="signal-row reason-row">
        <span class="signal-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
        <span class="signal-value" id="signalReason">‚Äì</span>
      </div>
    </section>

    <!-- BUTTON -->
    <button id="signalButton" class="btn" onclick="updateSignal()">
      üîÑ –ü–æ–ª—É—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª
    </button>
  </div>

  <!-- HISTORY TAB -->
  <div id="historyTab" style="display:none;">
    <section class="card">
      <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤</div>
      <div id="historyStatus" class="history-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <table class="history-table">
        <thead>
        <tr>
          <th>–í—Ä–µ–º—è</th>
          <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
          <th>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</th>
          <th>–¶–µ–Ω–∞</th>
          <th>Exp</th>
        </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </section>
  </div>

</div>

<script>
let apiBase = "";
let tvWidget = null;

// –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tabId, btn) {
  document.getElementById("signalTab").style.display =
    tabId === "signalTab" ? "block" : "none";
  document.getElementById("historyTab").style.display =
    tabId === "historyTab" ? "block" : "none";

  document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  if (tabId === "historyTab") {
    loadHistory();
  }
}

function setLoading(isLoading) {
  const btn = document.getElementById("signalButton");
  const ids = ["signalType", "signalProb", "signalPrice", "signalExpiry", "signalReason"];

  if (isLoading) {
    btn.classList.add("btn-loading");
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.classList.add("skeleton");
      el.classList.remove("fade-in");
    });
  } else {
    btn.classList.remove("btn-loading");
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove("skeleton");
      el.classList.add("fade-in");
    });
  }
}

// –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä
async function initPairs() {
  const params = new URLSearchParams(window.location.search);
  apiBase = params.get("api") || "";

  const select = document.getElementById("pairSelect");

  if (!apiBase) {
    select.innerHTML = "<option>‚ùå –ù–µ—Ç API</option>";
    document.getElementById("signalType").textContent =
      "‚ùå –û—à–∏–±–∫–∞: –ø–∞—Ä–∞–º–µ—Ç—Ä api –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ URL.";
    return;
  }

  try {
    const res = await fetch(`${apiBase}/pairs`);
    const data = await res.json();
    select.innerHTML = "";

    data.pairs.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      select.appendChild(opt);
    });

    select.addEventListener("change", () => {
      const pair = select.value;
      document.getElementById("pairLabel").textContent = pair;
      // –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä—ã –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
      loadChart(pair);
    });

    // –ø–µ—Ä–≤–∞—è –ø–∞—Ä–∞
    const defPair = data.pairs[0];
    select.value = defPair;
    document.getElementById("pairLabel").textContent = defPair;
    loadChart(defPair);
    // —Å—Ä–∞–∑—É –∑–∞–ø—Ä–æ—Å–∏–º –ø–µ—Ä–≤—ã–π —Å–∏–≥–Ω–∞–ª
    updateSignal();
  } catch (e) {
    console.error(e);
    select.innerHTML = "<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä</option>";
    document.getElementById("signalType").textContent =
      "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä.";
  }
}

// –∑–∞–ø—Ä–æ—Å —Å–∏–≥–Ω–∞–ª–∞
async function updateSignal() {
  if (!apiBase) return;
  const pair = document.getElementById("pairSelect").value || "EUR/USD";
  document.getElementById("pairLabel").textContent = pair;

  setLoading(true);
  document.getElementById("progressBar").style.width = "0%";

  try {
    const url = `${apiBase}/get_signal?pair=${encodeURIComponent(pair)}`;
    const res = await fetch(url);
    const data = await res.json();

    setLoading(false);

    if (data.error) {
      document.getElementById("signalType").textContent = "‚ö†Ô∏è –ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞";
      document.getElementById("signalProb").textContent = data.error;
      document.getElementById("signalPrice").textContent = "‚Äì";
      document.getElementById("signalExpiry").textContent = "‚Äì";
      document.getElementById("signalReason").textContent = "‚Äì";
      document.getElementById("progressBar").style.width = "0%";
      return;
    }

    const dirEl = document.getElementById("signalType");
    dirEl.classList.remove("buy", "sell", "wait");

    if (data.dir === "BUY") {
      dirEl.textContent = "üìà –ü–æ–∫—É–ø–∞—Ç—å";
      dirEl.classList.add("buy");
    } else if (data.dir === "SELL") {
      dirEl.textContent = "üîª –ü—Ä–æ–¥–∞–≤–∞—Ç—å";
      dirEl.classList.add("sell");
    } else {
      dirEl.textContent = "‚è∏ –û–∂–∏–¥–∞–Ω–∏–µ";
      dirEl.classList.add("wait");
    }

    document.getElementById("signalProb").textContent = `${data.prob}%`;
    document.getElementById("signalPrice").textContent = data.entry_price || "‚Äì";
    document.getElementById("signalExpiry").textContent =
      data.expiry ? `${data.expiry} –º–∏–Ω` : "‚Äì";
    document.getElementById("signalReason").textContent =
      data.reason || "‚Äî";

    document.getElementById("progressBar").style.width = `${data.prob || 0}%`;

    // –≥—Ä–∞—Ñ–∏–∫ + —Å—Ç—Ä–µ–ª–∫–∞
    loadChart(pair, data.entry_price, data.dir);

  } catch (e) {
    console.error(e);
    setLoading(false);
    document.getElementById("signalType").textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
    document.getElementById("signalProb").textContent = "";
  }
}

// –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
async function loadHistory() {
  if (!apiBase) return;
  const pair = document.getElementById("pairSelect").value || "EUR/USD";
  const symbol = pair.replace("/", "");
  const status = document.getElementById("historyStatus");
  const body = document.getElementById("historyBody");

  status.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
  body.innerHTML = "";

  try {
    const res = await fetch(`${apiBase}/signals?symbol=${symbol}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      status.textContent = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ.";
      return;
    }

    status.textContent = "";
    body.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.time || ""}</td>
        <td>${row.direction || ""}</td>
        <td>${row.prob || ""}</td>
        <td>${row.price || ""}</td>
        <td>${row.expiry || ""}</td>
      `;
      body.appendChild(tr);
    });

  } catch (e) {
    console.error(e);
    status.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.";
  }
}

// TradingView chart
function loadChart(pair, entryPrice=null, dir=null) {
  const containerId = "chartContainer";
  const symbol = pair.replace("/", "");

  // –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  const cont = document.getElementById(containerId);
  cont.innerHTML = "";

  if (typeof TradingView === "undefined") {
    cont.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ TradingView.";
    return;
  }

  tvWidget = new TradingView.widget({
    autosize: true,
    symbol: symbol,
    interval: "1",
    container_id: containerId,
    datafeed: undefined,
    library_path: "/",
    locale: "en",
    theme: "dark",
    style: "1",
    hide_top_toolbar: false,
    hide_legend: true,
    save_image: false,
  });

  if (entryPrice && !isNaN(parseFloat(entryPrice))) {
    tvWidget.onChartReady(function () {
      const chart = tvWidget.chart();
      chart.createMultipointShape(
        [{ price: parseFloat(entryPrice) }],
        {
          shape: dir === "SELL" ? "arrow_down" : "arrow_up",
          text: dir || "",
          lock: true,
          disableSelection: true,
        }
      );
    });
  }
}

// —Å—Ç–∞—Ä—Ç
document.addEventListener("DOMContentLoaded", initPairs);
</script>
</body>
</html>
